# 05 - ARC4NE API Design and Pseudocode

This document defines the RESTful API layer for ARC4NE, facilitating communication between the web UI, agents, and the backend server. [^1]

## 1. General Principles

*   **Base URL:** All API endpoints are prefixed with `/api`. [^1]
*   **Versioning:** URL Path Versioning is used, e.g., `/api/v1/...`. This allows for future API iterations without breaking existing clients. [^1]
*   **Authentication:** [^1]
    *   **Web UI Users:** JWT (JSON Web Tokens) sent in the `Authorization: Bearer <token>` header. Managed via login/refresh token flow.
    *   **Agents:** HMAC-SHA256 signature of the request payload, sent via custom headers (`X-Agent-ID`, `X-Signature`).
*   **Data Format:** JSON is used for all request and response bodies.
*   **HTTP Methods:** Standard HTTP methods are used (GET, POST, PUT, DELETE).
*   **Status Codes:** Standard HTTP status codes are used to indicate success or failure (e.g., 200 OK, 201 Created, 400 Bad Request, 401 Unauthorized, 403 Forbidden, 404 Not Found, 500 Internal Server Error).
*   **Rate Limiting:** Recommended for sensitive endpoints (e.g., login, agent registration) to prevent abuse. To be implemented in Phase 2/3. [^1]
*   **Documentation:** The API will be self-documented using OpenAPI/Swagger, automatically generated by FastAPI. This documentation will be available at an endpoint like `/api/docs`. [^1]

## 2. Endpoint Definitions

### 2.1 User Authentication (`/api/v1/auth`)

*   **`POST /login`** [^1]
    *   **Description:** Authenticates a web UI user and returns JWTs.
    *   **Request Body (`UserLoginSchema`):**
        \`\`\`json
        {
          "username": "admin_user",
          "password": "secure_password"
        }
        \`\`\`
    *   **Response Body (200 OK - `TokenSchema`):**
        \`\`\`json
        {
          "access_token": "generated.jwt.access_token",
          "token_type": "bearer"
        }
        \`\`\`
        *(Refresh token is sent as an HttpOnly cookie).*
*   **`POST /refresh`** [^1]
    *   **Description:** Refreshes an expired Access Token using a valid Refresh Token (sent as cookie).
    *   **Request Body:** None.
    *   **Response Body (200 OK - `TokenSchema`):**
        \`\`\`json
        {
          "access_token": "new.jwt.access_token",
          "token_type": "bearer"
        }
        \`\`\`
    *   **Authentication:** Requires valid Refresh Token cookie.
*   **`POST /logout`** [^1]
    *   **Description:** Logs out a user by invalidating their Refresh Token on the server.
    *   **Request Body:** None.
    *   **Response Body (200 OK):**
        \`\`\`json
        {
          "message": "Successfully logged out"
        }
        \`\`\`
    *   **Authentication:** Requires valid Refresh Token cookie (to identify which token to invalidate).
*   **`GET /users/me`** [^1]
    *   **Description:** Retrieves information about the currently authenticated UI user.
    *   **Request Body:** None.
    *   **Response Body (200 OK - `UserInfoSchema`):**
        \`\`\`json
        {
          "user_id": "uuid-of-user",
          "username": "admin",
          "email": "admin@example.com",
          "roles": ["admin", "operator"],
          "is_active": true
        }
        \`\`\`
    *   **Authentication:** JWT Bearer Token (UI User).

### 2.2 Agent Management (for Web UI - Admin RBAC) (`/api/v1/agents`)

*   **`POST /agents`** (Internal/Admin endpoint for MVP, later full UI) [^1]
    *   **Description:** Registers a new agent in the system. Returns Agent ID and PSK.
    *   **Request Body (`AgentCreateSchema`):**
        \`\`\`json
        {
          "name": "test-linux-agent-01",
          "os_info": "Ubuntu 22.04 LTS",
          "tags": ["critical", "webserver"]
        }
        \`\`\`
        *(Note: PSK is generated by the server, not taken as input here for security).*
    *   **Response Body (201 Created - `AgentRegistrationResponseSchema`):**
        \`\`\`json
        {
          "agent_id": "generated-uuid-for-agent",
          "name": "test-linux-agent-01",
          "psk": "generated-strong-preshared-key"
        }
        \`\`\`
    *   **Authentication:** JWT Bearer Token (UI User, Admin role).
*   **`GET /agents`** [^1]
    *   **Description:** Lists all registered agents. Supports filtering (e.g., by status, OS).
    *   **Query Parameters:** `status`, `os_type`, `tag`, `limit`, `offset`.
    *   **Response Body (200 OK - List of `AgentInfoSchema`):**
        \`\`\`json
        [
          {
            "agent_id": "uuid1", "name": "agent-01", "status": "online",
            "os_info": "Windows Server 2019", "last_seen": "2023-10-26T10:00:00Z",
            "internal_ip": "10.0.0.5", "agent_version": "0.1.1", "tags": ["prod"]
          }
        ]
        \`\`\`
    *   **Authentication:** JWT Bearer Token (UI User, Viewer+ role).
*   **`GET /agents/{agent_id}`** [^1]
    *   **Description:** Retrieves detailed information about a specific agent.
    *   **Path Parameter:** `agent_id` (UUID).
    *   **Response Body (200 OK - `AgentDetailSchema`):**
        \`\`\`json
        {
          "agent_id": "uuid1", "name": "agent-01", "status": "online",
          "os_info": "Windows Server 2019", "last_seen": "2023-10-26T10:00:00Z",
          "internal_ip": "192.168.1.10", "external_ip": "203.0.113.45",
          "agent_version": "0.1.0", "profile_id": "profile-uuid", "tags": ["prod", "db"]
        }
        \`\`\`
    *   **Authentication:** JWT Bearer Token (UI User, Viewer+ role).
*   **`PUT /agents/{agent_id}`**
    *   **Description:** Updates information for a specific agent (e.g., name, tags, assigned profile).
    *   **Path Parameter:** `agent_id` (UUID).
    *   **Request Body (`AgentUpdateSchema`):**
        \`\`\`json
        {
          "name": "renamed-agent-01",
          "tags": ["prod", "database-server"],
          "profile_id": "new-profile-uuid"
        }
        \`\`\`
    *   **Response Body (200 OK - `AgentDetailSchema`):** Updated agent details.
    *   **Authentication:** JWT Bearer Token (UI User, Admin role).
*   **`DELETE /agents/{agent_id}`** [^1]
    *   **Description:** De-registers/removes an agent from the system.
    *   **Path Parameter:** `agent_id` (UUID).
    *   **Response Body (204 No Content):**
    *   **Authentication:** JWT Bearer Token (UI User, Admin role).

### 2.3 Agent Communication (Agent Authenticated) (`/api/v1/agent`)

*   **`POST /beacon`** [^1]
    *   **Description:** Agent beacons in, sends status/basic telemetry, and receives new tasks or configuration updates.
    *   **Headers:** `X-Agent-ID`, `X-Signature`.
    *   **Request Body (`AgentBeaconSchema`):**
        \`\`\`json
        {
          "status": "idle",
          "basic_telemetry": {
            "os_info": "Ubuntu 22.04",
            "hostname": "ubuntu-agent",
            "agent_version": "0.1.0",
            "internal_ips": ["192.168.1.100"]
          },
          "task_results": [
            { "task_id": "prev-task-uuid", "status": "completed", "output": "Done.", "error_output": null, "exit_code": 0 }
          ]
        }
        \`\`\`
    *   **Response Body (200 OK - `BeaconResponseSchema`):**
        \`\`\`json
        {
          "acknowledged_at": "2023-10-26T10:00:05Z",
          "new_tasks": [
            { "task_id": "new-task-uuid", "type": "execute_command", "payload": {"command": "whoami"}, "timeout_seconds": 60 }
          ],
          "config_update": { "beacon_interval_seconds": 120, "jitter_percentage": 0.1 }
        }
        \`\`\`
    *   **Authentication:** Agent HMAC Signature.
*   **`POST /task_results`** [^1]
    *   **Description:** Agent reports results for one or more completed tasks (alternative to sending in beacon, for larger results or immediate reporting).
    *   **Headers:** `X-Agent-ID`, `X-Signature`.
    *   **Request Body (List of `TaskResultSchema`):**
        \`\`\`json
        [
          {
            "task_id": "task-uuid-1", "status": "completed",
            "output": "Result of command 1", "error_output": "", "exit_code": 0
          }
        ]
        \`\`\`
    *   **Response Body (200 OK):**
        \`\`\`json
        { "message": "1 task result(s) received and processed." }
        \`\`\`
    *   **Authentication:** Agent HMAC Signature.
*   **`POST /telemetry`** [^1]
    *   **Description:** Agent uploads a batch of detailed telemetry data.
    *   **Headers:** `X-Agent-ID`, `X-Signature`.
    *   **Request Body (`AgentTelemetryBatchSchema`):**
        \`\`\`json
        {
          "timestamp": "2023-10-26T10:05:00Z",
          "metrics": [
            { "metric_type": "cpu_usage_percent", "metric_value": 15.5, "unit": "%" },
            { "metric_type": "memory_usage_mb", "metric_value": 2048, "unit": "MB" }
          ]
        }
        \`\`\`
    *   **Response Body (200 OK):**
        \`\`\`json
        { "message": "Telemetry batch received." }
        \`\`\`
    *   **Authentication:** Agent HMAC Signature.

### 2.4 Task Management (for Web UI - Operator/Admin RBAC) (`/api/v1/tasks`)

*   **`POST /tasks`** [^1]
    *   **Description:** Creates and queues a new task for a specific agent.
    *   **Request Body (`TaskCreateSchema`):**
        \`\`\`json
        {
          "agent_id": "target-agent-uuid",
          "type": "execute_command",
          "payload": { "command": "ls -la /tmp" },
          "description": "List files in /tmp directory",
          "timeout_seconds": 120
        }
        \`\`\`
    *   **Response Body (201 Created - `TaskSchema`):** Details of the created task.
        \`\`\`json
        {
          "task_id": "newly-created-task-uuid", "agent_id": "target-agent-uuid", "agent_name": "target-agent-name",
          "type": "execute_command", "status": "queued", "description": "List files in /tmp directory",
          "created_at": "2023-10-26T10:10:00Z", "created_by_user_id": "user-uuid", "updated_at": "2023-10-26T10:10:00Z"
        }
        \`\`\`
    *   **Authentication:** JWT Bearer Token (UI User, Operator+ role).
*   **`GET /tasks`** [^1]
    *   **Description:** Lists all tasks, filterable by agent, status, type.
    *   **Query Parameters:** `agent_id`, `status`, `type`, `limit`, `offset`, `sort_by`, `sort_order`.
    *   **Response Body (200 OK - List of `TaskSchema`):**
    *   **Authentication:** JWT Bearer Token (UI User, Viewer+ role).
*   **`GET /tasks/{task_id}`** [^1]
    *   **Description:** Retrieves details and results for a specific task.
    *   **Path Parameter:** `task_id` (UUID).
    *   **Response Body (200 OK - `TaskDetailSchema`):**
        \`\`\`json
        {
          "task_id": "task-uuid", "agent_id": "target-agent-uuid", "agent_name": "target-agent-name",
          "type": "execute_command", "status": "completed", "description": "List files in /tmp directory",
          "created_at": "2023-10-26T10:10:00Z", "created_by_user_id": "user-uuid", "updated_at": "2023-10-26T10:10:06Z",
          "payload": { "command": "ls -la /tmp" },
          "output": "total 0\ndrwxrwxrwt 2 root root 40 Oct 26 10:00 .\n...",
          "error_output": "", "exit_code": 0,
          "started_at": "2023-10-26T10:10:05Z", "completed_at": "2023-10-26T10:10:06Z"
        }
        \`\`\`
    *   **Authentication:** JWT Bearer Token (UI User, Viewer+ role).
*   **`DELETE /tasks/{task_id}`** (Or `POST /tasks/{task_id}/cancel`)
    *   **Description:** Attempts to cancel a queued or running task. (Actual cancellation depends on agent responsiveness).
    *   **Path Parameter:** `task_id` (UUID).
    *   **Response Body (200 OK or 202 Accepted):**
        \`\`\`json
        { "message": "Task cancellation request sent. Status updated to 'cancelling'." }
        \`\`\`
    *   **Authentication:** JWT Bearer Token (UI User, Operator+ role).

### 2.5 Telemetry Retrieval (for Web UI - Viewer+ RBAC) (`/api/v1/telemetry`)

*   **`GET /telemetry/agents/{agent_id}`** [^1]
    *   **Description:** Retrieves telemetry data for a specific agent.
    *   **Path Parameter:** `agent_id` (UUID).
    *   **Query Parameters:** `metric_type`, `start_time` (ISO8601), `end_time` (ISO8601), `limit`, `agg_window` (e.g. '1m', '5m', '1h').
    *   **Response Body (200 OK - List of `TelemetryDataPointSchema` or aggregated structure):**
        \`\`\`json
        [
          { "timestamp": "2023-10-26T10:05:00Z", "metric_type": "cpu_usage_percent", "metric_value": 15.5, "unit": "%", "tags": null },
          { "timestamp": "2023-10-26T10:06:00Z", "metric_type": "cpu_usage_percent", "metric_value": 18.2, "unit": "%", "tags": null }
        ]
        \`\`\`
    *   **Authentication:** JWT Bearer Token (UI User, Viewer+ role).

## 3. JSON Schema Definitions (Conceptual Pydantic Models)

These models define the expected structure for request and response bodies. They would be implemented using Pydantic in the FastAPI backend. [^1]

\`\`\`python
from pydantic import BaseModel, Field, EmailStr
from typing import List, Optional, Dict, Any
from uuid import UUID, uuid4
from datetime import datetime

# --- User Auth Schemas ---
class UserLoginSchema(BaseModel):
    username: str
    password: str

class TokenData(BaseModel): # For JWT payload internal representation
    username: Optional[str] = None
    roles: List[str] = []
    # user_id: Optional[UUID] = None # Could also store user_id

class TokenSchema(BaseModel): # For API response
    access_token: str
    token_type: str = "bearer"
    # refresh_token: Optional[str] = None # Typically sent as HttpOnly cookie

class UserInfoSchema(BaseModel):
    user_id: UUID
    username: str
    email: Optional[EmailStr] = None
    roles: List[str]
    is_active: bool

# --- Agent Schemas ---
class AgentCreateSchema(BaseModel): # For UI to request agent creation
    name: str = Field(..., min_length=3, max_length=100)
    os_info: Optional[str] = Field(None, max_length=255)
    tags: Optional[List[str]] = Field(None, max_items=20)

class AgentRegistrationResponseSchema(BaseModel): # Response after creating agent
    agent_id: UUID
    name: str
    psk: str # The generated PSK, to be shown once to admin

class AgentInfoSchema(BaseModel): # For UI agent listing
    agent_id: UUID
    name: str
    status: str
    os_info: Optional[str] = None
    internal_ip: Optional[str] = None # Could be a list if multiple IPs
    external_ip: Optional[str] = None
    agent_version: Optional[str] = None
    last_seen: Optional[datetime] = None
    profile_id: Optional[UUID] = None
    tags: Optional[List[str]] = None
    model_config = {"from_attributes": True} # For ORM mode if using SQLAlchemy

class AgentDetailSchema(AgentInfoSchema): # More details for single agent view
    # Add more specific fields if needed, e.g., full config, detailed telemetry summary
    pass

class AgentUpdateSchema(BaseModel): # For updating agent details
    name: Optional[str] = Field(None, min_length=3, max_length=100)
    tags: Optional[List[str]] = Field(None, max_items=20)
    profile_id: Optional[UUID] = None

# --- Agent Communication Schemas ---
class AgentBasicTelemetry(BaseModel):
    os_info: str
    hostname: str
    agent_version: str
    internal_ips: Optional[List[str]] = None # List of internal IP addresses

class TaskResultSchema(BaseModel):
    task_id: UUID
    status: str # e.g., "completed", "failed", "timed_out", "error_unknown_task_id"
    output: Optional[str] = None
    error_output: Optional[str] = None
    exit_code: Optional[int] = None
    # started_at: Optional[datetime] = None # Agent can report these
    # completed_at: Optional[datetime] = None # Agent can report these

class AgentBeaconSchema(BaseModel):
    status: str # e.g., "idle", "processing_tasks"
    basic_telemetry: AgentBasicTelemetry
    task_results: Optional[List[TaskResultSchema]] = Field(None, max_items=50) # Limit batch size

class TaskInstructionSchema(BaseModel):
    task_id: UUID = Field(default_factory=uuid4)
    type: str # e.g., "execute_command", "file_download", "update_config"
    payload: Dict[str, Any] # Task-specific parameters
    timeout_seconds: Optional[int] = Field(300, gt=0, le=3600) # Default 5 mins, max 1 hour

class AgentConfigUpdateSchema(BaseModel): # For server to update agent config
    beacon_interval_seconds: Optional[int] = Field(None, gt=5, le=3600) # e.g., min 5s, max 1hr
    jitter_percentage: Optional[float] = Field(None, ge=0.0, le=0.5) # e.g., 0.0 to 0.5 (50%)
    # Other configurable parameters like telemetry verbosity, etc.

class BeaconResponseSchema(BaseModel):
    acknowledged_at: datetime = Field(default_factory=datetime.utcnow)
    new_tasks: List[TaskInstructionSchema] = Field(default_factory=list, max_items=10) # Limit tasks per beacon
    config_update: Optional[AgentConfigUpdateSchema] = None

class TelemetryDataPointSchema(BaseModel):
    metric_type: str # e.g., "cpu.usage.percent", "memory.free.bytes"
    metric_value: Any # Can be number, string, boolean, or a JSON object for complex metrics
    unit: Optional[str] = None
    tags: Optional[Dict[str, str]] = None # e.g., {"core": "1", "disk": "/dev/sda1"}

class AgentTelemetryBatchSchema(BaseModel):
    timestamp: datetime = Field(default_factory=datetime.utcnow) # Timestamp for the batch
    metrics: List[TelemetryDataPointSchema] = Field(..., max_items=1000) # Limit batch size

# --- Task Management Schemas (UI) ---
class TaskCreateSchema(BaseModel): # For UI to create a task
    agent_id: UUID
    type: str
    payload: Dict[str, Any]
    description: Optional[str] = Field(None, max_length=500)
    timeout_seconds: Optional[int] = Field(300, gt=0, le=86400) # Max 1 day

class TaskSchema(BaseModel): # For UI task listing
    task_id: UUID
    agent_id: UUID
    agent_name: Optional[str] = None # Denormalized for UI convenience
    type: str
    status: str
    description: Optional[str] = None
    created_at: datetime
    created_by_user_id: Optional[UUID] = None
    updated_at: Optional[datetime] = None # When status last changed
    model_config = {"from_attributes": True}

class TaskDetailSchema(TaskSchema): # For UI task detail view
    payload: Dict[str, Any]
    output: Optional[str] = None
    error_output: Optional[str] = None
    exit_code: Optional[int] = None
    started_at: Optional[datetime] = None
    completed_at: Optional[datetime] = None
    model_config = {"from_attributes": True}

# --- System Configuration / Agent Profile Schemas ---
class AgentProfileSchema(BaseModel):
    id: UUID
    name: str
    description: Optional[str] = None
    is_default: bool = False
    config_data: AgentConfigUpdateSchema # Re-use agent config update schema for profile content
    created_at: datetime
    updated_at: datetime
    model_config = {"from_attributes": True}

class AgentProfileCreateSchema(BaseModel):
    name: str = Field(..., min_length=3, max_length=100)
    description: Optional[str] = None
    config_data: AgentConfigUpdateSchema
\`\`\`
